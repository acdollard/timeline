---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import TimelineContainer from "../components/TimelineContainer";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

let session = null;
if (accessToken && refreshToken) {
  try {
    const result = await supabase.auth.setSession({
      refresh_token: refreshToken.value,
      access_token: accessToken.value,
    });
    if (!result.error) {
      session = result.data.session;
    }
  } catch (error) {
    // Session is already null, no need to handle error
  }
}

if (!session) {
  return Astro.redirect("/signin");
}

// Get initial events for the user
const { data: eventsData } = await supabase
  .from("events")
  .select(
    `
    *,
    event_types (
      id,
      name,
      display_name,
      color,
      icon
    ),
    event_photos (
      id,
      event_id,
      user_id,
      file_name,
      file_path,
      file_size,
      mime_type,
      alt_text,
      sort_order,
      created_at,
      updated_at
    )
  `
  )
  .eq("user_id", session.user.id)
  .order("date", { ascending: true });

// Enrich events with photos that have signed URLs
let events = eventsData || [];
if (events.length > 0) {
  const eventsWithPhotos = await Promise.all(
    events.map(async (event) => {
      if (event.event_photos && event.event_photos.length > 0) {
        const photosWithUrls = await Promise.all(
          event.event_photos.map(async (photo: any) => {
            const { data: urlData } = await supabase.storage
              .from("event-photos")
              .createSignedUrl(photo.file_path, 3600);
            
            return {
              ...photo,
              url: urlData?.signedUrl || ""
            };
          })
        );
        event.photos = photosWithUrls;
        delete event.event_photos;
      } else {
        event.photos = [];
      }
      return event;
    })
  );
  events = eventsWithPhotos;
}
---

<Layout>
  <div class="container mx-auto px-4 py-8">
    <h1
      id="timeline-heading"
      class="text-4xl font-bold text-white mx-auto text-center"
    >
      Summary Page
    </h1>
    <div
      class="w-full min-h-[45vh] rounded-lg flex flex-col justify-end items-center relative pb-18"
    >
      <TimelineContainer
        client:load
        events={events || []}
        sessionId={session.user.id}
      />
    </div>
  </div>
</Layout>
